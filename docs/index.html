<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食品加工 AI 新技術日報</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <h2>今日報告</h2>
            <div id="latest-report-btn" class="report-item active">最新報告</div>

            <h3>歷史報告</h3>
            <div id="history-list">
                <!-- 這裡會由 JavaScript 自動填入歷史報告列表 -->
                <p class="loading">載入中...</p>
            </div>

            <div class="footer">
                <p>資料來源: Claude AI & DuckDuckGo</p>
            </div>
        </aside>

        <main class="content">
            <header>
                <h1 id="report-title">正在載入報告...</h1>
                <span id="report-date" class="date-badge"></span>
            </header>

            <div id="report-content" class="markdown-body">
                <!-- 報告內容將顯示在此 -->
            </div>
        </main>
    </div>

    <script>
        const REPORTS_INDEX = 'reports.json';

        async function fetchReportList() {
            try {
                // 讀取靜態索引檔
                const response = await fetch(REPORTS_INDEX);
                if (!response.ok) throw new Error('無法獲取報告列表');

                const reports = await response.json();
                renderSidebar(reports);

                if (reports.length > 0) {
                    loadReport(reports[0].url, reports[0].name);
                } else {
                    document.getElementById('report-content').innerHTML = '<p>目前沒有任何報告。</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('history-list').innerHTML = '<p class="error">載入索引失敗。請確認 GitHub Pages 設定是否正確，且已執行過一次手動更新。</p>';
            }
        }

        function renderSidebar(reports) {
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';

            reports.forEach((report, index) => {
                const item = document.createElement('div');
                item.className = 'report-item';
                item.textContent = report.date; // Use pre-formatted date from JSON

                item.onclick = () => {
                    document.querySelectorAll('.report-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    loadReport(report.url, report.name);
                };

                if (index === 0) document.getElementById('latest-report-btn').classList.add('active');
                listContainer.appendChild(item);
            });
        }

        async function loadReport(url, filename) {
            document.getElementById('report-content').innerHTML = '<div class="spinner"></div>';
            document.getElementById('report-title').textContent = '載入中...';

            try {
                const response = await fetch(url);
                const text = await response.text();

                document.getElementById('report-content').innerHTML = marked.parse(text);

                // 解析日期：food_ai_digest_20260215.md -> 2026/02/15
                const dateMatch = filename.match(/(\d{4})(\d{2})(\d{2})/);
                if (dateMatch) {
                    document.getElementById('report-title').textContent = `${dateMatch[1]}年${dateMatch[2]}月${dateMatch[3]}日 摘要報告`;
                    document.getElementById('report-date').textContent = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
                } else {
                    document.getElementById('report-title').textContent = filename;
                }

            } catch (error) {
                document.getElementById('report-content').innerHTML = '<p>無法載入報告內容。</p>';
            }
        }

        // 初始化
        fetchReportList();
    </script>
</body>

</html>