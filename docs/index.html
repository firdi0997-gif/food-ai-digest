<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>食品加工 AI 新技術日報</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>今日報告</h2>
            <div id="latest-report-btn" class="report-item active">最新報告</div>
            
            <h3>歷史報告</h3>
            <div id="history-list">
                <!-- 這裡會由 JavaScript 自動填入歷史報告列表 -->
                <p class="loading">載入中...</p>
            </div>
            
            <div class="footer">
                <p>資料來源: Claude AI & DuckDuckGo</p>
            </div>
        </aside>

        <main class="content">
            <header>
                <h1 id="report-title">正在載入報告...</h1>
                <span id="report-date" class="date-badge"></span>
            </header>
            
            <div id="report-content" class="markdown-body">
                <!-- 報告內容將顯示在此 -->
            </div>
        </main>
    </div>

    <script>
        const REPO_OWNER = 'firdi0997-gif'; // 請替換為您的 GitHub 使用者名稱
        const REPO_NAME = 'food-ai-digest'; // 請替換為您的儲存庫名稱
        const BRANCH = 'main';
        const FOLDER_PATH = 'docs/reports';

        async function fetchReportList() {
            try {
                // 使用 GitHub API 獲取報告列表
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FOLDER_PATH}?ref=${BRANCH}`);
                if (!response.ok) throw new Error('無法獲取報告列表');
                
                const data = await response.json();
                // 過濾 .md 檔案並按日期倒序排列
                const reports = data
                    .filter(file => file.name.endsWith('.md'))
                    .sort((a, b) => b.name.localeCompare(a.name)); // 假設檔名格式為 YYYYMMDD，倒序排列最新在最前

                renderSidebar(reports);
                if (reports.length > 0) {
                    loadReport(reports[0].download_url, reports[0].name);
                } else {
                    document.getElementById('report-content').innerHTML = '<p>目前沒有任何報告。</p>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('history-list').innerHTML = '<p class="error">載入失敗。請確認 GitHub Pages 設定是否正確。</p>';
                // Fallback: 嘗試載入本地的 latest.md (如果有建立的話)
            }
        }

        function renderSidebar(reports) {
            const listContainer = document.getElementById('history-list');
            listContainer.innerHTML = '';

            reports.forEach((report, index) => {
                const item = document.createElement('div');
                item.className = 'report-item';
                // 解析日期：food_ai_digest_20260215.md -> 2026-02-15
                const dateMatch = report.name.match(/(\d{4})(\d{2})(\d{2})/);
                const dateDisplay = dateMatch ? `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}` : report.name;
                
                item.textContent = dateDisplay;
                item.onclick = () => {
                    document.querySelectorAll('.report-item').forEach(el => el.classList.remove('active'));
                    item.classList.add('active');
                    loadReport(report.download_url, report.name);
                };
                
                if (index === 0) document.getElementById('latest-report-btn').classList.add('active');
                listContainer.appendChild(item);
            });
        }

        async function loadReport(url, filename) {
            document.getElementById('report-content').innerHTML = '<div class="spinner"></div>';
            document.getElementById('report-title').textContent = '載入中...';
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                
                document.getElementById('report-content').innerHTML = marked.parse(text);
                
                 // 解析日期：food_ai_digest_20260215.md -> 2026/02/15
                const dateMatch = filename.match(/(\d{4})(\d{2})(\d{2})/);
                if (dateMatch) {
                    document.getElementById('report-title').textContent = `${dateMatch[1]}年${dateMatch[2]}月${dateMatch[3]}日 摘要報告`;
                    document.getElementById('report-date').textContent = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
                } else {
                    document.getElementById('report-title').textContent = filename;
                }

            } catch (error) {
                document.getElementById('report-content').innerHTML = '<p>無法載入報告內容。</p>';
            }
        }

        // 初始化
        fetchReportList();
    </script>
</body>
</html>
